---
layout: default
title: 로드밸런싱과 L4
parent: 네트워크 및 개발환경
nav_order: 3
permalink: /devops/03
---

# 로드밸런싱?
<br>
{: .no_toc }
기존에 한 천명만 접속하던 프로젝트가 수십만명에 접근하는 프로젝트로 거대해졌다. 그렇다면 이러한 상황에서 가장 우려해야 할점은 바로 트래픽 관리이다. 
이러한 상황에서 2가지 방식을 고민할것이다. Scale-up(서버의 하드웨어 성능을 올린다) 또는 Scale-out(여러대의 서버로 분산하여 처리한다) 방식이다.
현시점에서는 주로 Scale-out을 선택하는 추세이다. 왜냐하면 하드웨어의 성능을 높이는 가격보다 서버 한대를 늘리는 방향이 더욱 적다. 
그리고 배포시 서버 이중화로 인해 에러에 대처할수 있기 때문이다. 그렇다면 이러한 여러대의 서버를 하나의 서버로 묶어주는 방식이 필요하다.
이럴때 사용하는 서비스를 로드밸런싱이라고 칭한다.

---
# 로드밸런서 종류
<br>
- 운영체제 로드밸런서 : 물리적 프로세서간 스케쥴링
- 네트워크 로드밸런서 : 네트워크단에서 스케쥴링 각 OSI 7계층에 따란 이름이 지어진다
    >   L2 : MAC Address 스위칭

    >   L3 : IP주소를 확인하여 스위칭

    >   L4 : IP주소 및 TCP/UDP 포트로 스위칭

    >   L5 : IP주소 및 TCP/UDP 포트정보와 패킷 내용을 참조하여 스위칭

이들중 우리는 이장에서는 L4에 관해 알아보자

# 로드밸런서 주요기술
<br>
- NAT(Network Address Translation) :
    사설 IP를 공인 IP로 변경
- DSR(Dynamic Source Routing protocol) :
    서버에서 클라이언트로 응답시 목적지주소를 클라이언트 IP로 전달하여 네트워크 스위치를 거치지 않고 바로 전달
- Tunneling :
    데이터를 캡슐화하여 처리

---

# L4
-   OSI 4 게층에 속하여 IP주소 및 TCP/UDP 포트로 스위칭 시킨다
-   TCP/UDP Protocol을 사용한다
-   VIP 와 매핑테이블을 통해 분산시킨다
    > VIP :Virtual IP의 약자이다. 여러 서버를 대표하는 IP를 말한다. L4의 IP이기도 하며 서버와 클라이어트간 통신을 이어주는 IP이다.

-   주로 Round Robin을 사용한다
    > Round Robin : 분상 알고리즘중 하나, 아래에서 다루겠다.

## L4 주요장점
- 로드 밸런싱 기능
    > 하나의 아이피로 요청을 통일시켜 공통 처리를 가능하고 트래픽을 나눌수 있다

- 무결성
    > VIP 이중화 처리가 가능하여 VIP 장비의 오류에도 문제없이 동작이 가능하다

## L4 스위칭 과정
![](/assets/images/L4_step.PNG)

1.   클라이언트가 해당 VIP로 연결된 도메인으로 Http 접근합니다.
2.   L4장비는 내부의 알고리즘을 통해 처리 서버를 선별하여 요청을 보냅니다.
3.   처리서버는 작업의 결과를 L4장비로 전송합니다.
4.   전달받은 L4장비는 클라이언트에게 결과를 전달합니다.

## L4 처리서버 선별 알고리즘
1. Round Robin(순차방식)
    -   요청을 순서대로 각서버에 균등하게 보낸다.
    -   서버 컨넥션 갯수 나 응답시간에 상관없이 동일하게 처리
    -   가장 빠른 알고리즘
2. Least Connection(최소접속방식)
    -   컨넥션 갯수가 가장 적은 곳으로 보낸다.
3. Weighted Least Connections(가중치 최소접속방식)
    -   서버에 부여된 Weight 값을 기반으로 Connection 수의 개수와 같이 고려하여 할당
4. Fastest Response Time(응답시간방식)
    -   가장 빠른 응답시간을 가진 서버에게 요청을 보낸다.
5. Adaptive(최소대기방식)
    -   Open, Pending 커넥션을 적게 가지고 있는 서버로 보내는 방식으로 최소접속방식과는 달리 Pending의 갯수도 생각한다.
        Pending 커넥션은 Full TCP Handshake를 완성하지 않은 것으로, 이것은 초당 클라이언트 Thread의 수가 증가할 때 더욱 잘 수행된다.
6. Hash
    -   Client와 Server간에 한번의 세션에 적립되면 계속 해당 서버로 보낸다. 주로 IP를 나머지연산하여 처리한다.
7. Minimum Misses
    -   Hash와 같은 방식이나 서버가 하나 제외 되었을 경우 해당서버의 사용자만 재할당 하는 방식이다.


---

참고

> https://ckddn9496.tistory.com/31

> https://pakss328.medium.com/%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C%EB%9E%80-l4-l7-501fd904cf05








